---
# AWX Dynamic Inventory Playbook
# This playbook dynamically adds hosts from extra_vars and runs tasks on them
# No need for external inventory - hosts are added at runtime!

- name: Build Dynamic Inventory from Extra Vars
  hosts: localhost
  gather_facts: false
  
  vars:
    runtime_hosts: []  # Will be passed from AWX API
    batch_id: "{{ batch_id | default('BATCH000') }}"
    requested_by: "{{ requested_by | default('API') }}"
    output_dir: "{{ output_dir | default('/tmp/awx-logs') }}"

  tasks:
    - name: Display job information
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  AWX Dynamic Inventory Job Started       â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Batch ID: {{ batch_id }}
          â•‘  Requested By: {{ requested_by }}
          â•‘  Hosts Count: {{ runtime_hosts | length }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Add hosts to in-memory inventory
      add_host:
        name: "{{ item.name }}"
        ansible_host: "{{ item.ip }}"
        ansible_user: "{{ item.user | default('ubuntu') }}"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        groups:
          - dynamic_servers
        # Pass through custom variables
        batch_id: "{{ batch_id }}"
        requested_by: "{{ requested_by }}"
        output_dir: "{{ output_dir }}"
      loop: "{{ runtime_hosts }}"
      when: runtime_hosts | length > 0

    - name: Fail if no hosts provided
      fail:
        msg: "No runtime_hosts provided in extra_vars!"
      when: runtime_hosts | length == 0


- name: Execute Tasks on Dynamic Servers
  hosts: dynamic_servers
  gather_facts: true
  become: yes
  
  tasks:
    - name: Show target host info
      debug:
        msg: |
          ğŸ–¥ï¸  Host: {{ inventory_hostname }}
          ğŸŒ  IP: {{ ansible_host }}
          ğŸ“‹  Batch: {{ batch_id }}
          ğŸ‘¤  Requested By: {{ requested_by }}

    - name: Create output directory
      file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'

    - name: Collect system facts
      shell: |
        echo "=== System Report ==="
        echo "Hostname: $(hostname -f)"
        echo "IP: $(hostname -I | awk '{print $1}')"
        echo "OS: $(cat /etc/os-release 2>/dev/null | grep PRETTY_NAME | cut -d'"' -f2)"
        echo "Kernel: $(uname -r)"
        echo "CPU: $(nproc) cores"
        echo "Memory: $(free -h | awk '/Mem:/{print $2}')"
        echo "Disk: $(df -h / | awk 'NR==2{print $4}') free"
        echo "Uptime: $(uptime -p)"
        echo "===================="
      register: system_report
      changed_when: false

    - name: Display system report
      debug:
        var: system_report.stdout_lines

    - name: Save report to file
      copy:
        content: |
          AWX Job Report
          ==============
          Generated: {{ ansible_date_time.iso8601 }}
          Batch ID: {{ batch_id }}
          Requested By: {{ requested_by }}
          
          {{ system_report.stdout }}
        dest: "{{ output_dir }}/report_{{ inventory_hostname }}_{{ batch_id }}.txt"
        mode: '0644'

    - name: Success message
      debug:
        msg: "âœ… Completed successfully on {{ inventory_hostname }} ({{ ansible_host }})"


- name: Summary
  hosts: localhost
  gather_facts: false
  
  tasks:
    - name: Job completion summary
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  âœ… AWX Job Completed Successfully!      â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Batch ID: {{ batch_id }}
          â•‘  Hosts Processed: {{ groups['dynamic_servers'] | length }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
