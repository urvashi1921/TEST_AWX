---
# AWX Dynamic Inventory Playbook
# This playbook dynamically adds hosts from extra_vars and runs tasks on them
# No need for external inventory - hosts are added at runtime!

- name: Build Dynamic Inventory from Extra Vars
  hosts: localhost
  gather_facts: false
  
  vars:
    runtime_hosts: []
    batch_id: "{{ batch_id | default('BATCH000') }}"
    requested_by: "{{ requested_by | default('API') }}"
    output_dir: "{{ output_dir | default('/tmp/awx-logs') }}"

  tasks:
    - name: Display job information
      debug:
        msg: |
          ========================================
          AWX Dynamic Inventory Job Started
          ========================================
          Batch ID: {{ batch_id }}
          Requested By: {{ requested_by }}
          Hosts Count: {{ runtime_hosts | length }}
          ========================================

    - name: Add hosts to in-memory inventory
      add_host:
        name: "{{ item.name }}"
        ansible_host: "{{ item.ip }}"
        ansible_user: "{{ item.user | default('ubuntu') }}"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        groups:
          - dynamic_servers
        batch_id: "{{ batch_id }}"
        requested_by: "{{ requested_by }}"
        output_dir: "{{ output_dir }}"
      loop: "{{ runtime_hosts }}"
      when: runtime_hosts | length > 0

    - name: Fail if no hosts provided
      fail:
        msg: "No runtime_hosts provided in extra_vars!"
      when: runtime_hosts | length == 0


- name: Execute Tasks on Dynamic Servers
  hosts: dynamic_servers
  gather_facts: true
  become: yes
  
  tasks:
    - name: Show target host info
      debug:
        msg: |
          Host: {{ inventory_hostname }}
          IP: {{ ansible_host }}
          Batch: {{ batch_id }}
          Requested By: {{ requested_by }}

    - name: Create output directory
      file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'

    - name: Get hostname
      command: hostname -f
      register: cmd_hostname
      changed_when: false

    - name: Get IP address
      shell: hostname -I | awk '{print $1}'
      register: cmd_ip
      changed_when: false

    - name: Get OS info
      shell: cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d '"'
      register: cmd_os
      changed_when: false

    - name: Get kernel version
      command: uname -r
      register: cmd_kernel
      changed_when: false

    - name: Get CPU count
      command: nproc
      register: cmd_cpu
      changed_when: false

    - name: Get memory info
      shell: free -h | awk '/Mem:/{print $2}'
      register: cmd_memory
      changed_when: false

    - name: Get disk info
      shell: df -h / | awk 'NR==2{print $4}'
      register: cmd_disk
      changed_when: false

    - name: Get uptime
      command: uptime -p
      register: cmd_uptime
      changed_when: false

    - name: Display system report
      debug:
        msg: |
          === System Report ===
          Hostname: {{ cmd_hostname.stdout }}
          IP: {{ cmd_ip.stdout }}
          OS: {{ cmd_os.stdout }}
          Kernel: {{ cmd_kernel.stdout }}
          CPU: {{ cmd_cpu.stdout }} cores
          Memory: {{ cmd_memory.stdout }}
          Disk Free: {{ cmd_disk.stdout }}
          Uptime: {{ cmd_uptime.stdout }}
          =====================

    - name: Save report to file
      copy:
        content: |
          AWX Job Report
          ==============
          Generated: {{ ansible_date_time.iso8601 }}
          Batch ID: {{ batch_id }}
          Requested By: {{ requested_by }}
          
          === System Report ===
          Hostname: {{ cmd_hostname.stdout }}
          IP: {{ cmd_ip.stdout }}
          OS: {{ cmd_os.stdout }}
          Kernel: {{ cmd_kernel.stdout }}
          CPU: {{ cmd_cpu.stdout }} cores
          Memory: {{ cmd_memory.stdout }}
          Disk Free: {{ cmd_disk.stdout }}
          Uptime: {{ cmd_uptime.stdout }}
          =====================
        dest: "{{ output_dir }}/report_{{ inventory_hostname }}_{{ batch_id }}.txt"
        mode: '0644'

    - name: Success message
      debug:
        msg: "Completed successfully on {{ inventory_hostname }} ({{ ansible_host }})"


- name: Summary
  hosts: localhost
  gather_facts: false
  
  tasks:
    - name: Job completion summary
      debug:
        msg: |
          ========================================
          AWX Job Completed Successfully!
          ========================================
          Batch ID: {{ batch_id }}
          Hosts Processed: {{ groups['dynamic_servers'] | length }}
          ========================================