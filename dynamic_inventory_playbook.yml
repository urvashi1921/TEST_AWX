---
# AWX Dynamic Inventory Playbook
# Hosts are passed via extra_vars and added dynamically using add_host

- name: Build Dynamic Inventory from Extra Vars
  hosts: localhost
  gather_facts: false
  connection: local

  tasks:
    - name: Display job information
      vars:
        _batch_id: "{{ batch_id | default('BATCH000') }}"
        _requested_by: "{{ requested_by | default('API') }}"
        _host_count: "{{ runtime_hosts | default([]) | length }}"
      debug:
        msg:
          - "========================================"
          - "AWX Dynamic Inventory Job Started"
          - "========================================"
          - "Batch ID: {{ _batch_id }}"
          - "Requested By: {{ _requested_by }}"
          - "Hosts Count: {{ _host_count }}"
          - "========================================"

    - name: Validate runtime_hosts is provided
      fail:
        msg: "ERROR: runtime_hosts variable is required but not provided!"
      when: runtime_hosts is not defined or runtime_hosts | length == 0

    - name: Add hosts to in-memory inventory
      add_host:
        name: "{{ item.name }}"
        ansible_host: "{{ item.ip }}"
        ansible_user: "{{ item.user | default('ubuntu') }}"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        groups:
          - dynamic_servers
        host_batch_id: "{{ batch_id | default('BATCH000') }}"
        host_requested_by: "{{ requested_by | default('API') }}"
        host_output_dir: "{{ output_dir | default('/tmp/awx-logs') }}"
      loop: "{{ runtime_hosts }}"

    - name: Show added hosts
      debug:
        msg: "Added {{ runtime_hosts | length }} hosts to dynamic_servers group"


- name: Execute Tasks on Dynamic Servers
  hosts: dynamic_servers
  gather_facts: true
  become: yes

  tasks:
    - name: Show target host info
      debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "IP: {{ ansible_host }}"
          - "Batch: {{ host_batch_id }}"
          - "Requested By: {{ host_requested_by }}"

    - name: Create output directory
      file:
        path: "{{ host_output_dir }}"
        state: directory
        mode: "0755"

    - name: Get hostname
      command: hostname -f
      register: cmd_hostname
      changed_when: false
      ignore_errors: true

    - name: Get IP address
      shell: hostname -I | awk '{print $1}'
      register: cmd_ip
      changed_when: false

    - name: Get OS info
      shell: cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d '"'
      register: cmd_os
      changed_when: false
      ignore_errors: true

    - name: Get kernel version
      command: uname -r
      register: cmd_kernel
      changed_when: false

    - name: Get CPU count
      command: nproc
      register: cmd_cpu
      changed_when: false

    - name: Get memory info
      shell: free -h | awk '/Mem:/{print $2}'
      register: cmd_memory
      changed_when: false

    - name: Get disk info
      shell: df -h / | awk 'NR==2{print $4}'
      register: cmd_disk
      changed_when: false

    - name: Get uptime
      command: uptime -p
      register: cmd_uptime
      changed_when: false
      ignore_errors: true

    - name: Display system report
      debug:
        msg:
          - "=== System Report ==="
          - "Hostname: {{ cmd_hostname.stdout | default('N/A') }}"
          - "IP: {{ cmd_ip.stdout | default('N/A') }}"
          - "OS: {{ cmd_os.stdout | default('N/A') }}"
          - "Kernel: {{ cmd_kernel.stdout | default('N/A') }}"
          - "CPU: {{ cmd_cpu.stdout | default('N/A') }} cores"
          - "Memory: {{ cmd_memory.stdout | default('N/A') }}"
          - "Disk Free: {{ cmd_disk.stdout | default('N/A') }}"
          - "Uptime: {{ cmd_uptime.stdout | default('N/A') }}"
          - "====================="

    - name: Save report to file
      copy:
        content: |
          AWX Job Report
          ==============
          Generated: {{ ansible_date_time.iso8601 }}
          Batch ID: {{ host_batch_id }}
          Requested By: {{ host_requested_by }}
          
          === System Report ===
          Hostname: {{ cmd_hostname.stdout | default('N/A') }}
          IP: {{ cmd_ip.stdout | default('N/A') }}
          OS: {{ cmd_os.stdout | default('N/A') }}
          Kernel: {{ cmd_kernel.stdout | default('N/A') }}
          CPU: {{ cmd_cpu.stdout | default('N/A') }} cores
          Memory: {{ cmd_memory.stdout | default('N/A') }}
          Disk Free: {{ cmd_disk.stdout | default('N/A') }}
          Uptime: {{ cmd_uptime.stdout | default('N/A') }}
          =====================
        dest: "{{ host_output_dir }}/report_{{ inventory_hostname }}_{{ host_batch_id }}.txt"
        mode: "0644"

    - name: Success message
      debug:
        msg: "Completed successfully on {{ inventory_hostname }} ({{ ansible_host }})"


- name: Summary
  hosts: localhost
  gather_facts: false
  connection: local

  tasks:
    - name: Job completion summary
      debug:
        msg:
          - "========================================"
          - "AWX Job Completed Successfully!"
          - "========================================"
          - "Hosts Processed: {{ groups['dynamic_servers'] | length }}"
          - "========================================"